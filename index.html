<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Escala de Conners — Professores</title>
<style>
  :root{
    --bg:#0e1625; --card:#14213b; --line:#2b3f66;
    --text:#f8fafc; --muted:#cbd5e1;
    --pri:#6d28d9; --ok:#10b981; --err:#ef4444; --warn:#f59e0b;
    --chip:#0b1220; --chipHover:#0f1a2e; --chipSel:#1e293b;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:var(--bg);color:var(--text);
    font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  }
  .wrap{max-width:1024px;margin:20px auto;padding:0 16px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:18px}
  h1{margin:0 0 6px;font-size:1.45rem}
  .muted{color:var(--muted)}

  .grid-info{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:12px;
    margin:12px 0 6px
  }
  @media(max-width:720px){.grid-info{grid-template-columns:1fr}}
  .info{
    background:rgba(0,0,0,.18);
    border:1px solid var(--line);
    border-radius:12px;
    padding:12px
  }
  .info b{display:block;margin-bottom:4px;color:#e2e8f0}

  .legend{display:flex;flex-wrap:wrap;gap:8px;margin:6px 0 12px}
  .pill{
    display:inline-block;
    padding:4px 8px;
    border-radius:999px;
    border:1px solid var(--line);
    background:rgba(0,0,0,.25);
    font-size:.86rem
  }

  /* bloco de cada pergunta */
  .item{
    border:1px solid var(--line);
    border-radius:12px;
    padding:12px;
    background:rgba(0,0,0,.18);
    margin-bottom:12px
  }
  .stem{font-size:1rem;margin-bottom:10px}

  /* escala de resposta */
  .scale{
    display:grid;
    grid-template-columns:repeat(4,minmax(140px,1fr));
    gap:10px
  }
  @media(max-width:680px){
    .scale{grid-template-columns:1fr}
  }

  .opt{
    display:flex;
    align-items:center;
    gap:10px;
    padding:10px 12px;
    border:1px solid var(--line);
    border-radius:12px;
    background:var(--chip);
    cursor:pointer;
    transition:background .15s ease,border-color .15s ease,transform .05s ease
  }
  .opt:hover{
    background:var(--chipHover);
    border-color:#4f70ff;
    transform:translateY(-1px)
  }
  .opt input{
    appearance:none;
    -webkit-appearance:none;
    width:0;height:0;
    position:absolute;
    opacity:0
  }
  .opt span{font-weight:600}
  .opt small{opacity:.8;font-size:.82rem;line-height:1.3}
  .opt:has(input:checked){
    background:var(--chipSel);
    border-color:#6d28d9;
    box-shadow:0 0 0 1px #6d28d9 inset
  }

  /* ações */
  .btn{
    display:inline-flex;
    align-items:center;
    gap:10px;
    background:var(--pri);
    border:none;
    color:#fff;
    padding:12px 16px;
    border-radius:12px;
    cursor:pointer;
    font-weight:600
  }
  .btn.ok{background:var(--ok)}
  .btn.ghost{
    background:transparent;
    border:1px solid var(--line);
    color:var(--muted)
  }
  .btn:disabled{opacity:.6;cursor:not-allowed}

  /* mensagens */
  .msg{
    margin:12px 0;
    padding:12px;
    border-radius:10px
  }
  .okbox{
    background:#06351f;
    border:1px solid #0e6c45;
    color:#c8ffe3
  }
  .errbox{
    background:#3b0d0d;
    border:1px solid #7f1d1d;
    color:#ffd5d5
  }
  .warnbox{
    background:#3a2903;
    border:1px solid #885e09;
    color:#ffe6b0
  }

  /* progresso */
  .progress{
    height:10px;
    background:rgba(255,255,255,.05);
    border:1px solid var(--line);
    border-radius:999px;
    overflow:hidden
  }
  .bar{
    height:100%;
    width:0%;
    background:linear-gradient(90deg,#6d28d9,#10b981)
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Escala de Conners — Professores</h1>
    <p class="muted">
      Pense em como o aluno(a) tem se comportado <b>recentemente</b> (últimas semanas/meses).
      As respostas serão enviadas diretamente para a profissional responsável
      <p>

    <div class="legend">
      <span class="pill">Nunca</span>
      <span class="pill">Às vezes</span>
      <span class="pill">Frequentemente</span>
      <span class="pill">Sempre</span>
    </div>

    <!-- Dados identificadores -->
    <div id="pacInfo" class="grid-info" style="display:none;"></div>

    <!-- barra de progresso -->
    <div id="progressWrap" style="display:none;gap:8px;align-items:center;margin:8px 0 0;">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:6px">
        <span class="muted" id="progressText">Progresso: 0/0</span>
        <button id="clearDraft" class="btn ghost" type="button" title="Limpar rascunho salvo neste dispositivo">Limpar rascunho</button>
      </div>
      <div class="progress"><div class="bar" id="bar"></div></div>
    </div>

    <!-- formulário -->
    <form id="form" style="margin-top:14px;display:none" novalidate>
      <div id="qs"></div>

      <div style="margin-top:14px;display:flex;gap:10px;flex-wrap:wrap">
        <button id="btnSubmit" class="btn ok" type="submit">Enviar respostas</button>
        <button id="btnSave" class="btn ghost" type="button" title="Salvar rascunho localmente">Salvar rascunho</button>
      </div>

      <div id="msg" class="msg" style="display:none" role="alert" aria-live="polite"></div>
    </form>

    <!-- alerta inicial / erros de abertura -->
    <div id="alert" class="msg" style="display:none" role="alert" aria-live="assertive"></div>
  </div>
</div>

<script>
/* ========= CONFIG ========= */
const SHEETDB_BASE = "https://sheetdb.io/api/v1/8pmdh33s9fvy8";
const SHEETS = {
  PATIENTS:"Patients",
  TOKENS:"LinkTokens",
  SCORES:"Scores_CONNERS_PROFESSORES"
};
const CODE = "CONNERS_PROFESSORES";
const PORTAL_URL = "https://integradaneuropsicologia.github.io/formularios/";
const RELEASE_KEYS = ["CONNERS_PROFESSORES"]; // colunas no Patients com "sim" para liberar

/* ========= HELPERS ========= */
const $ = s => document.querySelector(s);
const onlyDigits = s => (s||"").replace(/\D+/g,"");
const qs = k => new URLSearchParams(location.search).get(k) || "";
const TOKEN = qs("token");

function setBox(id, text, kind="ok"){
  const el=$(id); if(!el) return;
  el.textContent = text;
  el.className = "msg " + (
    kind==="ok" ? "okbox" :
    kind==="warn" ? "warnbox" :
    "errbox"
  );
  el.style.display = "block";
}
function hideBox(id){
  const el=$(id);
  if(!el) return;
  el.style.display="none";
  el.textContent="";
}
function maskCPF(cpf){
  const d = onlyDigits(cpf||"");
  if(d.length!==11) return cpf||"";
  return `${d.slice(0,3)}.${d.slice(3,6)}.${d.slice(6,9)}-${d.slice(9)}`;
}
function fmtDateISO(iso){
  if(!iso) return "";
  const [y,m,d] = String(iso).split("-");
  if(!y||!m||!d) return iso;
  return `${d}/${m}/${y}`;
}

async function GET(url){
  const r=await fetch(url);
  if(!r.ok) throw new Error("HTTP "+r.status);
  return r.json();
}
async function sheetSearch(sheet, params){
  const usp=new URLSearchParams(params);
  return GET(`${SHEETDB_BASE}/search?sheet=${encodeURIComponent(sheet)}&${usp.toString()}`);
}
async function sheetCreate(sheet, row){
  const r = await fetch(
    `${SHEETDB_BASE}?sheet=${encodeURIComponent(sheet)}`,
    {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ data:[row] })
    }
  );
  if(!r.ok) throw new Error(await r.text());
  return r.json();
}
async function sheetPatchBy(sheet, column, value, data){
  const r = await fetch(
    `${SHEETDB_BASE}/${encodeURIComponent(column)}/${encodeURIComponent(value)}?sheet=${encodeURIComponent(sheet)}`,
    {
      method:"PATCH",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ data })
    }
  );
  if(!r.ok) throw new Error(await r.text());
  return r.json();
}

function goPortalWithToken(){
  try{
    const u=new URL(PORTAL_URL,location.href);
    if(TOKEN) u.searchParams.set("token",TOKEN);
    location.href=u.toString();
  }catch(_){
    const sep=PORTAL_URL.includes("?")?"&":"?";
    location.href=PORTAL_URL + (TOKEN ? sep+"token="+encodeURIComponent(TOKEN) : "");
  }
}

/* ========= ITENS ========= */
const ITEMS = [
"Constantemente se mexendo",
"Emite sons, ruídos",
"Pedidos tem que ser imediatamente atendidos",
"Coordenação motora comprometida, fraca",
"Inquieto, superativo",
"Excitável, impulsivo",
"Desatento, facilmente distraído",
"Não termina o que começa",
"Extremamente sensível",
"Extremamente sério, triste",
"Sonha acordado",
"Mal-humorado, rabugento",
"Chora com freqüência e facilidade",
"Perturba outras crianças",
"Provoca confusões",
"Humor muda drasticamente com rapidez",
"Matreiro, faz-se de esperto",
"Destrutivo",
"Furta",
"Mente",
"Explosões de raiva, comportamento imprevisível, explosivo.",
"Isola-se de outras crianças",
"Parece não ser aceito pelo grupo",
"Parece se deixar levar com facilidade",
"Não tem “espírito esportivo”",
"Parece não ter liderança",
"Não se relaciona bem com o sexo oposto",
"Não se relaciona bem com crianças do mesmo sexo",
"Provoca outras crianças ou interfere com as suas atividades",
"Submissa",
"Desafiadora",
"Atrevida",
"Tímida",
"Medrosa",
"Excessiva exigência da atenção do professor",
"Teimosa",
"Excessivamente ansiosa para agradar",
"De não cooperação.",
"Falta à aula com freqüência"

];
const TOTAL_ITEMS = ITEMS.length;

/* opções de resposta */
const CHOICES = [
  {v:0, l:"Nunca"},
  {v:1, l:"Às vezes"},
  {v:2, l:"Frequentemente"},
  {v:3, l:"Sempre"}
];

/* ========= RENDER ========= */
function renderQuestions(){
  const host=$("#qs"); host.innerHTML="";

  ITEMS.forEach((txt,idx)=>{
    const qNum = idx+1;
    const qn   = String(qNum).padStart(2,"0");

    const row=document.createElement("div");
    row.className="item";
    row.setAttribute("data-q",String(qNum));

    const stem=document.createElement("div");
    stem.className="stem";
    stem.id=`s${qn}`;
    stem.textContent=`${qNum}. ${txt}`;

    const scale=document.createElement("div");
    scale.className="scale";

    CHOICES.forEach(c=>{
      const lab=document.createElement("label");
      lab.className="opt";
      lab.setAttribute("title",`${c.l} (${c.v})`);
      const id=`q${qn}_${c.v}`;
      lab.innerHTML = `
        <input type="radio" name="q${qn}" id="${id}" value="${c.v}" required aria-labelledby="s${qn}">
        <span>${c.l}</span>
        <small></small>
      `;
      scale.appendChild(lab);
    });

    row.append(stem,scale);
    host.appendChild(row);
  });

  // texto inicial do progresso
  $("#progressText").textContent = `Progresso: 0/${TOTAL_ITEMS}`;
}

/* ========= ESTADO ========= */
let patient=null, tokenRow=null, CPF="";
let startAt=Date.now();
const STORAGE_KEY = `CONNERS_PROFESSORES_${TOKEN||"anon"}`;

/* ========= BOOT ========= */
(async function boot(){
  try{
    if(!TOKEN){
      setBox("#alert","Link inválido (sem token). Solicite um novo link.","err");
      return;
    }

    // Token
    const trows = await sheetSearch(SHEETS.TOKENS,{ token:TOKEN });
    if(!trows || !trows.length) throw new Error("Token inválido ou expirado.");
    tokenRow = trows[0];

    const disabled = String(tokenRow.disabled||"não").toLowerCase()==="sim";
    const expired  = tokenRow.expires_at && (new Date(tokenRow.expires_at) < new Date());
    if(disabled || expired) throw new Error("Token desativado/expirado. Peça um novo link.");

    CPF = onlyDigits(tokenRow.cpf||"");
    if(!CPF) throw new Error("Token sem CPF vinculado.");

    // Paciente
    const prows = await sheetSearch(SHEETS.PATIENTS,{ cpf:CPF });
    if(!prows || !prows.length) throw new Error("Paciente não encontrado.");
    patient = prows[0];

    // Liberação
    const isAllowed = RELEASE_KEYS.some(k => String(patient[k]||"").trim().toLowerCase()==="sim");
    if(!isAllowed){
      setBox("#alert","Este formulário não está liberado para você. Entre em contato com o consultório.","err");
      return;
    }

    // Já respondeu?
    const doneKeys   = RELEASE_KEYS.map(k => `${k}_FEITO`);
    const anyDoneFlag= doneKeys.some(k => String(patient[k]||"").trim().toLowerCase()==="sim");
    const already    = await sheetSearch(SHEETS.SCORES,{ cpf:CPF, code:CODE });
    if(anyDoneFlag || (already && already.length)){
      setBox("#alert","Você já respondeu este formulário. Voltando ao portal…","ok");
      setTimeout(goPortalWithToken,1200);
      return;
    }

    // Render e restaura rascunho
    renderPatientInfo();
    renderQuestions();
    restoreDraft();
    updateProgress();

    $("#pacInfo").style.display="grid";
    $("#form").style.display="block";
    $("#progressWrap").style.display="block";
    hideBox("#alert");

    startAt = Date.now();
  }catch(err){
    console.error(err);
    setBox("#alert", err.message || "Falha ao abrir o formulário. Tente novamente mais tarde.", "err");
  }
})();

/* ========= PACIENTE ========= */
function renderPatientInfo(){
  const g=$("#pacInfo"); g.innerHTML="";
  const info = [
    ["Nome", patient.nome || "-"],
    
    ["Nascimento", fmtDateISO(patient.data_nascimento)],
    
  ];
  for(const [k,v] of info){
    const div=document.createElement("div");
    div.className="info";
    div.innerHTML=`<b>${k}</b><div>${v||"-"}</div>`;
    g.appendChild(div);
  }
}

/* ========= RASCUNHO LOCAL ========= */
function saveDraft(){
  const data={};
  for(let i=1;i<=TOTAL_ITEMS;i++){
    const qn=String(i).padStart(2,"0");
    const sel=document.querySelector(`input[name="q${qn}"]:checked`);
    if(sel) data[`q${qn}`]=Number(sel.value);
  }
  try{
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  }catch(_){
    // ignore quota errors
  }
}
function restoreDraft(){
  try{
    const raw=localStorage.getItem(STORAGE_KEY);
    if(!raw) return;
    const data=JSON.parse(raw||"{}");
    for(const [name,val] of Object.entries(data||{})){
      const el=document.querySelector(`input[name="${name}"][value="${val}"]`);
      if(el) el.checked=true;
    }
  }catch(_){}
}
function clearDraft(){
  try{ localStorage.removeItem(STORAGE_KEY); }catch(_){}
}

/* ========= PROGRESSO ========= */
function countAnswered(){
  let c=0;
  for(let i=1;i<=TOTAL_ITEMS;i++){
    const qn=String(i).padStart(2,"0");
    if(document.querySelector(`input[name="q${qn}"]:checked`)) c++;
  }
  return c;
}
function updateProgress(){
  const ans=countAnswered();
  $("#progressText").textContent = `Progresso: ${ans}/${TOTAL_ITEMS}`;
  $("#bar").style.width = `${(ans/TOTAL_ITEMS)*100}%`;
}

/* ========= EVENTOS ========= */
addEventListener('change', e=>{
  if(e.target && e.target.matches('input[type="radio"][name^="q"]')){
    saveDraft();
    updateProgress();
  }
});
$("#btnSave").addEventListener('click', ()=>{
  saveDraft();
  setBox("#msg","Rascunho salvo neste dispositivo.","ok");
});
$("#clearDraft").addEventListener('click', ()=>{
  clearDraft();
  setBox("#msg","Rascunho apagado.","warn");
});

/* ========= SUBMIT ========= */
let sending=false;
$("#form").addEventListener("submit", async (e)=>{
  e.preventDefault();
  if(sending) return;
  sending=true; hideBox("#msg");

  const btn=$("#btnSubmit");
  const originalText=btn.textContent;
  btn.disabled=true;
  btn.textContent="Enviando…";

  try{
    if(!patient) throw new Error("Sessão inválida. Recarregue o link.");

    // valida tudo respondido
    for(let i=1;i<=TOTAL_ITEMS;i++){
      const qn=String(i).padStart(2,"0");
      if(!document.querySelector(`input[name="q${qn}"]:checked`)){
        const row=document.querySelector(`.item[data-q="${i}"]`);
        if(row) row.scrollIntoView({behavior:'smooth',block:'center'});
        throw new Error(`Responda a questão ${i}.`);
      }
    }

    // soma total, coleta respostas e monta array pergunta->resposta
    let total=0;
    const answers={};
    const qaList=[]; // vai pra coluna "questions"

    for(let i=1;i<=TOTAL_ITEMS;i++){
      const qn=String(i).padStart(2,"0");
      const sel=document.querySelector(`input[name="q${qn}"]:checked`);
      const v=Number(sel.value);
      total += v;
      answers[`q${qn}`]=v;

      // pega label textual correspondente ao valor v
      const choiceObj = CHOICES.find(c => c.v === v) || { l:"" };

      qaList.push({
        n:i,                                 // número da pergunta
        q:ITEMS[i-1],                        // texto da pergunta
        v:v,                                 // valor numérico marcado (0..3)
        label:choiceObj.l                    // texto marcado
      });
    }

    // checa duplicidade
    const again=await sheetSearch(SHEETS.SCORES,{ cpf:CPF, code:CODE });
    if(again && again.length){
      setBox("#msg","Este formulário já foi enviado anteriormente. Voltando ao portal…","ok");
      setTimeout(goPortalWithToken,1000);
      return;
    }

    const durationSec=Math.round((Date.now()-startAt)/1000);

    // envia resultados para planilha, agora incluindo 'questions'
    await sheetCreate(SHEETS.SCORES,{
      result_id:`${patient.cpf}_${CODE}_${Date.now()}`,
      token:TOKEN,
      cpf:patient.cpf,
      code:CODE,
      source:"responsável",
      submitted_at:new Date().toISOString(),
      total: total,               // soma (0..3) de todos os itens
      categoria: "",              // sem subescalas definidas aqui
      questions: "",                 //JSON.stringify(qaList), // <-- perguntas + respostas
      metrics: ""                  //JSON.stringify({answers, duration_sec: durationSec, scale:"0-3"})
    });

    // marca como feito no Patients
    const doneUpdates = {};
    RELEASE_KEYS.map(k=>`${k}_FEITO`).forEach(k=>{
      if(k in patient) doneUpdates[k] = "sim";
    });
    if(Object.keys(doneUpdates).length===0){
      doneUpdates[`${RELEASE_KEYS[0]}_FEITO`] = "sim";
    }
    await sheetPatchBy(SHEETS.PATIENTS,"cpf",patient.cpf,doneUpdates);

    clearDraft();
    setBox("#msg","Formulário enviado. Voltando ao portal…","ok");
    setTimeout(goPortalWithToken,1100);

  }catch(err){
    console.error(err);
    setBox("#msg", err.message || "Falha ao enviar. Tente novamente.", "err");
    sending=false;
    btn.disabled=false;
    btn.textContent=originalText;
  }
});
</script>
</body>
</html>
